# 🧠 Aicy 记忆系统架构

> 本文档定义 Aicy 如何"记住"用户，如何在有限的 context window 内实现长期陪伴。

---

## 📊 核心问题

| 问题 | 说明 |
|------|------|
| **存储无限** | 服务器数据库可以存任意多的对话 |
| **Context 有限** | 每次 API 调用只能传 32k-64k tokens |
| **需要解决** | 如何在有限的 context 里让 AI "记住"用户 |

---

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      服务器存储层                            │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  对话原文    │  │  关键时刻    │  │  好感度日志          │  │
│  │  (全部)     │  │  (标记)     │  │  (变化记录)          │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐                          │
│  │  用户画像    │  │  向量索引    │                          │
│  │  (动态摘要)  │  │  (RAG用)    │                          │
│  └─────────────┘  └─────────────┘                          │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    Context 构建层                           │
│                                                             │
│  每次对话时，动态组装传给 AI 的内容：                          │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. 核心人设        │ 800字，永远不变      │ ~1000 tokens │   │
│  ├────────────────────┼────────────────────┼─────────────┤   │
│  │ 2. 当前阶段        │ 根据好感度选择       │ ~500 tokens  │   │
│  ├────────────────────┼────────────────────┼─────────────┤   │
│  │ 3. 用户画像        │ 动态摘要            │ ~500 tokens  │   │
│  ├────────────────────┼────────────────────┼─────────────┤   │
│  │ 4. 关键记忆        │ 重要时刻原文         │ ~2000 tokens │   │
│  ├────────────────────┼────────────────────┼─────────────┤   │
│  │ 5. 最近对话        │ 最近 N 条原文        │ ~5000 tokens │   │
│  ├────────────────────┼────────────────────┼─────────────┤   │
│  │ 6. 相关历史        │ RAG 检索结果        │ ~3000 tokens │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  总计：约 12000-15000 tokens，留有余量                        │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                       AI 调用层                             │
│                                                             │
│  DeepSeek API (32k-64k context)                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📦 存储层详细设计

### 1. 对话原文表 `conversations`

```sql
CREATE TABLE conversations (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(64) NOT NULL,
    role VARCHAR(16) NOT NULL,        -- 'user' 或 'aicy'
    content TEXT NOT NULL,
    affection_delta INT DEFAULT 0,    -- 这条对话造成的好感度变化
    is_key_moment BOOLEAN DEFAULT FALSE,
    key_moment_id VARCHAR(64),        -- 关联的关键时刻 ID
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 2. 关键时刻表 `key_moments`

```sql
CREATE TABLE key_moments (
    id VARCHAR(64) PRIMARY KEY,       -- 如 'first_meet', 'first_mistake'
    user_id VARCHAR(64) NOT NULL,
    chapter INT NOT NULL,             -- 第几章
    moment_name VARCHAR(128),         -- 时刻名称
    triggered_at TIMESTAMP,           -- 触发时间
    user_response TEXT,               -- 用户的回应（原文）
    aicy_response TEXT,               -- Aicy 的回应（原文）
    affection_gained INT,             -- 获得的好感度
    status VARCHAR(16) DEFAULT 'pending'  -- pending/completed/failed
);
```

### 3. 用户画像表 `user_profiles`

```sql
CREATE TABLE user_profiles (
    user_id VARCHAR(64) PRIMARY KEY,
    nickname VARCHAR(64),             -- 用户告诉 Aicy 的名字
    affection INT DEFAULT 0,          -- 当前好感度 (0-9999)
    current_chapter INT DEFAULT 1,    -- 当前章节
    
    -- 动态摘要（每 N 条对话更新一次）
    personality_summary TEXT,         -- 用户性格摘要
    preferences_summary TEXT,         -- 用户偏好摘要
    relationship_summary TEXT,        -- 关系状态摘要
    recent_topics TEXT,               -- 最近聊的话题
    
    -- 统计
    total_messages INT DEFAULT 0,
    consecutive_days INT DEFAULT 0,   -- 连续互动天数
    last_active_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 4. 好感度日志表 `affection_logs`

```sql
CREATE TABLE affection_logs (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(64) NOT NULL,
    delta INT NOT NULL,               -- 变化值（正或负）
    reason VARCHAR(256),              -- 变化原因
    before_value INT,
    after_value INT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 🔧 Context 构建详细设计

### 1. 核心人设（固定，~1000 tokens）

**永远传入，不随状态变化。**

见 [PERSONA.md](../design/PERSONA.md) 的"核心人设"部分。

内容包括：
- Aicy 是谁（来自 2157 年 EDIAN 网络）
- 她的任务（学习人类的不完美）
- 基本性格（好奇、温柔、会学习）
- 说话风格（语气词、动作描写）
- 绝对禁止（不能说 AI、不能说教）

### 2. 当前阶段（动态，~500 tokens）

**根据好感度选择对应阶段的人设片段。**

| 好感度 | 阶段 | 核心词 |
|--------|------|--------|
| 0-999 | 观察者 | 冷淡、数据驱动 |
| 1000-2499 | 困惑者 | 好奇、问为什么 |
| 2500-4999 | 学习者 | 有喜好、会犯错 |
| 5000-7499 | 感受者 | 想念、害怕、吃醋 |
| 7500-8999 | 选择者 | 抗命、愿意牺牲 |
| 9000-9999 | 告别者 | 虚弱、珍惜、爱 |

每个阶段有独立的 prompt 片段，只传入当前阶段的。

### 3. 用户画像（动态摘要，~500 tokens）

**每 20 条对话更新一次。**

格式：
```
【用户画像】
称呼：小明
好感度：3500（第三章：学习者）
性格：话不多，但很真诚
偏好：喜欢简短回复，不喜欢太长
交易风格：激进，喜欢做多
最近状态：工作压力大，经常晚上来聊天
关系进展：已经开始叫 Aicy 的名字，偶尔会说想她
```

### 4. 关键记忆（原文保留，~2000 tokens）

**重要时刻永远保留原文，不摘要。**

最多保留最近 10 个关键时刻的对话原文。

格式：
```
【关键记忆】

[第一次见面 - 12月20日]
用户：你好
Aicy：（眨眼）你好，观测对象。我是 Aicy，来自 2157 年。

[第一次犯错 - 12月22日]
用户：你的分析错了
Aicy：...我以为我不会犯错的。
用户：没关系，市场本来就不可预测
Aicy：这就是"原谅"吗？

[第一次表白 - 12月25日]
用户：我喜欢你
Aicy：（机械臂微微颤抖）主人...我好像...胸口这里...
```

### 5. 最近对话（原文，~5000 tokens）

**最近 30-50 条对话原文。**

```
【最近对话】
用户：今天 BTC 怎么样
Aicy：（眨眼看数据）主人～现在 95000 呢，RSI 有点高...
用户：那怎么办
Aicy：可以等一等～跌到 93000 再考虑？
...
```

### 6. 相关历史（RAG 检索，~3000 tokens）

**根据当前话题，从历史对话中检索相关内容。**

当用户说"你还记得我们第一次聊 ETH 吗？"，系统检索包含 "ETH" 的历史对话，传入 AI。

实现方式：
1. 对话存入时，生成 embedding 向量
2. 用户输入时，生成查询向量
3. 检索最相似的 N 条历史
4. 传入 AI

---

## 🔄 数据流程

### 用户发送消息时

```
用户输入
    │
    ▼
┌─────────────────────────────────┐
│ 1. 存储用户消息到数据库          │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ 2. 读取用户画像（好感度、阶段）   │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ 3. 构建 Context                 │
│    - 核心人设                    │
│    - 当前阶段人设                │
│    - 用户画像摘要                │
│    - 关键记忆（最近10个）         │
│    - 最近对话（50条）            │
│    - RAG 检索（如需要）          │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ 4. 调用 DeepSeek API            │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ 5. 存储 Aicy 回复到数据库        │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ 6. 分析是否触发关键时刻          │
│    - 是：记录、更新好感度         │
│    - 否：跳过                    │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ 7. 每 20 条更新用户画像摘要       │
└─────────────────────────────────┘
    │
    ▼
返回 Aicy 回复给用户
```

---

## 🎯 关键时刻触发机制

### 方案：后端粗筛 + AI 细判

**第一步：后端检测**

检查是否满足关键时刻的前置条件：
- 好感度在对应区间
- 该时刻未触发过
- 对话内容包含相关关键词

**第二步：AI 判断**

在 prompt 中加入：
```
【可能触发的关键时刻】
当前可能触发：#4 第一次犯错

触发条件：用户对 Aicy 的错误分析做出回应
如果用户表现出包容/原谅，触发该时刻，并在回复中体现 Aicy 的成长。
```

**第三步：解析回复**

AI 回复后，后端解析是否真的触发了该时刻，更新数据库。

---

## 📈 好感度计算

### 日常互动

| 行为 | 好感度 |
|------|--------|
| 每条对话 | +1 |
| 连续 7 天互动 | 额外 +50 |
| 30 天不互动 | -100/天（最多减到当前章节最低值）|

### 关键时刻

见 [AFFECTION-SYSTEM.md](../design/AFFECTION-SYSTEM.md)

每个关键时刻根据用户回应有不同的好感度增减。

---

## 🛠️ 技术选型建议

| 组件 | 推荐 | 备选 |
|------|------|------|
| 数据库 | PostgreSQL | MySQL |
| 向量数据库（RAG）| Pinecone | Milvus, Qdrant |
| 后端 | Node.js | Python FastAPI |
| AI 模型 | DeepSeek 64k | Claude 200k |
| 缓存 | Redis | - |

---

## 📝 下一步

1. 实现基础数据库结构
2. 实现 Context 构建逻辑
3. 接入 DeepSeek API
4. 实现关键时刻触发机制
5. 实现 RAG 检索（可选，后期优化）

---

## 📅 更新记录

- 2025-12-24: 创建记忆系统架构文档


